
group: edge

services:
  - docker

env:
  global:
    - CONSUL_VERSION=${CONSUL_VERSION:-1.0.6}
    - BUILD_DATE=$(date +"%Y-%m-%d")

jobs:
  include:
    - stage: build docker image
      script:
        - make
    - stage: test images & upload
      script:
        - docker-compose --file docker-compose_example.yml up --build -d
        - tests/test.sh
        - docker-compose --file docker-compose_example.yml kill
        - docker-compose --file docker-compose_example.yml down
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
        - make publish

install:
  - docker build --tag bodsch/docker-consul .
  - docker run --detach --name consul bodsch/docker-consul

script:
  - docker ps | grep -q consul

after_success:
  - |
    [ "${TRAVIS_BRANCH}" == "master" ] && curl \
      --request POST \
      --header "Content-Type: application/json"  \
      --data '{"source_type":"Branch","source_name":"master"}' \
      https://registry.hub.docker.com/u/bodsch/docker-consul/trigger/${DOCKER_HUB_TOKEN}/
